<?xml version="1.0" encoding="UTF-8"?>

<library name="Core" directory="Core">
  <import name="Type" pre="yes"/>

  <include file="lbcpp/Core/Pair.h"/>
  <include file="lbcpp/Core/Vector.h"/>
  <include file="lbcpp/Core/DynamicObject.h"/>
  <include file="lbcpp/Function/Function.h"/>

  <!-- Pair -->
  <template name="Pair" base="Object">
    <parameter name="firstType" type="Variable"/>
    <parameter name="secondType" type="Variable"/>

    <variable type="firstType" name="first"/>
    <variable type="secondType" name="second"/>
  </template>
  
  <!-- Container -->
  <template name="Container" base="Object" abstract="yes">
    <parameter name="elementsType"/>
  </template>
  
  <!-- Vector -->
  <template name="Vector" base="Container[elementsType]" abstract="yes">
    <parameter name="elementsType"/>
  </template>

  <template name="GenericVector" base="Vector[elementsType]">
    <parameter name="elementsType"/>
    <constructor arguments="TypePtr elementsType, size_t initialSize" parameters="elementsType"/>
  </template>

  <template name="ObjectVector" base="Vector[elementsType]">
    <parameter name="elementsType"/>
    <constructor arguments="TypePtr elementsType, size_t initialSize" parameters="elementsType"/>
  </template>

  <class name="BooleanVector" base="Vector[Boolean]">
    <constructor arguments="size_t initialSize"/>
  </class>

  <class name="VariableVector" base="Vector[Variable]">
    <constructor arguments="size_t initialSize"/>
  </class>
  
  <!-- Dynamic Object -->
  <class name="DynamicClass" base="DefaultClass" abstract="yes"/>

  <template name="EnumBasedDoubleVector" metaclass="DynamicClass">
    <parameter name="enumeration" type="EnumValue"/>
    <parameter name="variablesType" type="Double"/>
    <code>
      virtual size_t getNumMemberVariables() const
        {return getEnumeration()->getNumElements();}
        
      virtual VariableSignaturePtr getMemberVariable(size_t index) const
        {return new VariableSignature(getVariablesType(), getEnumeration()->getElementName(index));}
        
      virtual void createObjectVariables()
      {
        EnumerationPtr enumeration = getEnumeration();
        size_t n = enumeration->getNumElements();
        TypePtr variablesType = getVariablesType();
        for (size_t i = 0; i &lt; n; ++i)
          addMemberVariable(defaultExecutionContext(), variablesType, enumeration->getElementName(i));
      }
       
      EnumerationPtr getEnumeration() const
      {
        jassert(getNumTemplateArguments() == 2);
        EnumerationPtr enumeration = getTemplateArgument(0).dynamicCast&lt;Enumeration&gt;();
        jassert(enumeration);
        return enumeration;
      }
         
      TypePtr getVariablesType() const
        {jassert(getNumTemplateArguments() == 2); return getTemplateArgument(1);}
    </code>
  </template>
  
  <template name="OneSubObjectPerInputVariable" base="Object" metaclass="DynamicClass">
    <parameter name="inputClass" type="Object"/>
    <parameter name="outputVariablesType" type="Variable"/>
    <code>
      virtual void createObjectVariables()
      {
        jassert(getNumTemplateArguments() == 2);
        ClassPtr inputClass = getTemplateArgument(0).dynamicCast&lt;Class&gt;();
        TypePtr outputVariablesType = getTemplateArgument(1);
        jassert(inputClass);
        size_t n = inputClass->getNumMemberVariables();
        for (size_t i = 0; i &lt; n; ++i)
          addMemberVariable(defaultExecutionContext(), outputVariablesType, inputClass->getMemberVariableName(i));
      }
    </code>
  </template>

  <template name="AddMissingToEnumeration" metaclass="Enumeration">
    <parameter name="enumeration" type="EnumValue"/>
    <code>
      EnumerationPtr getEnumeration() const
        {return getTemplateArgument(0).dynamicCast&lt;Enumeration&gt;();}
 
      virtual size_t getNumElements() const
        {return getEnumeration()-&gt;getNumElements() + 1;}

      virtual EnumerationElementPtr getElement(size_t index) const
      {
        EnumerationPtr enumeration = getEnumeration();
        if (index &lt; enumeration-&gt;getNumElements())
          return enumeration->getElement(index);
        else
          return new EnumerationElement(T("missing"), T("_"), String::empty, T("Missing Value"));
      }
      </code>
  </template>

  <template name="AddEntropyToEnumeration" metaclass="Enumeration">
    <parameter name="enumeration" type="EnumValue"/>
    <code>
      EnumerationPtr getEnumeration() const
        {return getTemplateArgument(0).dynamicCast&lt;Enumeration&gt;();}
 
      virtual size_t getNumElements() const
        {return getEnumeration()-&gt;getNumElements() + 1;}

      virtual EnumerationElementPtr getElement(size_t index) const
      {
        EnumerationPtr enumeration = getEnumeration();
        if (index &lt; enumeration-&gt;getNumElements())
          return enumeration->getElement(index);
        else
          return new EnumerationElement(T("entropy"), String::empty, String::empty, T("Entropy"));
      }
      </code>
  </template>

  <template name="VariablesEnumeration" metaclass="Enumeration">
    <parameter name="class" type="Object"/>
    <code>
      ClassPtr getTargetClass() const
        {return getTemplateArgument(0).dynamicCast&lt;Class&gt;();}
 
      virtual size_t getNumElements() const
        {return getTargetClass()-&gt;getNumMemberVariables();}

      virtual EnumerationElementPtr getElement(size_t index) const
      {
        VariableSignaturePtr variable = getTargetClass()-&gt;getMemberVariable(index);
        return new EnumerationElement(variable->getName(), String::empty, variable->getShortName(), variable->getDescription());
      }
    </code>
  </template>

  <enumeration name="MissingOrPresent">
    <value name="missing" oneLetterCode="m"/>
    <value name="present" oneLetterCode="v"/>
  </enumeration>

  <class name="PositiveIntegerEnumeration" metaclass="Enumeration">
    <code>
      virtual size_t getNumElements() const
        {return 0;}
      virtual EnumerationElementPtr getElement(size_t index) const
        {String str((int)index); return new EnumerationElement(T("[") + str + T("]"), String::empty, str);}
    </code>
  </class>
  
  
  <!-- Function -->
  <class name="Function" abstract="yes">
    <variable type="ObjectVector[VariableSignature]" name="inputVariables"/>
    <variable type="VariableSignature" name="outputVariable"/>
    <variable type="Boolean" name="pushIntoStack"/>
  </class>

  <class name="ProxyFunction" base="Function" abstract="yes"/>

</library>
